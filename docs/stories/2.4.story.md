# Story 2.4: Multi-Turn Conversation Management

## Status
Draft

## Story
**As a** patient,  
**I want** to ask follow-up questions during the same call,  
**so that** I can get complete information without having to call back multiple times.

## Acceptance Criteria
1. Implement conversation session management that maintains context across multiple exchanges
2. Create natural conversation flow that can handle topic changes and follow-up questions
3. Design graceful conversation ending with clear next steps or appointment scheduling options
4. Implement conversation timeout handling with polite transition to scheduling or escalation
5. Create conversation memory that can reference earlier parts of the same call
6. Test complex multi-turn conversations including topic switches and clarification requests

## Tasks / Subtasks
- [ ] Implement conversation session management system (AC: 1, 5)
  - [ ] Design conversation state storage using Redis with TTL-based expiration
  - [ ] Create conversation context data structure including patient verification, topics discussed, and current intent
  - [ ] Implement session identifier generation and tracking across voice service calls
  - [ ] Set up conversation state persistence between individual speech-to-text exchanges
  - [ ] Configure session timeout values (default: 10 minutes inactive, max: 30 minutes total)

- [ ] Build natural conversation flow handling (AC: 2)
  - [ ] Implement topic change detection using GPT-4 conversation analysis
  - [ ] Create conversation flow state machine with states: greeting, verification, inquiry, follow-up, closing
  - [ ] Design context-aware response generation that references previous conversation turns
  - [ ] Implement interruption handling for when patients speak during AI responses
  - [ ] Create smooth transitions between different inquiry types within same conversation

- [ ] Design graceful conversation ending flows (AC: 3)
  - [ ] Implement conversation conclusion detection using natural language patterns
  - [ ] Create personalized closing responses based on information provided during conversation
  - [ ] Design clear next-step recommendations (scheduling, calling during business hours, website resources)
  - [ ] Implement appointment scheduling transition for patients ready to book
  - [ ] Create confirmation that all patient questions have been addressed

- [ ] Implement timeout and escalation handling (AC: 4)
  - [ ] Create polite timeout warnings at conversation milestones (5 min, 8 min warnings)
  - [ ] Implement automatic conversation wrap-up when approaching session limits
  - [ ] Design seamless transition to appointment scheduling when conversation reaches natural end
  - [ ] Create escalation pathways for patients needing extended assistance
  - [ ] Implement hold music or callback options for staff escalation scenarios

- [ ] Build conversation memory and reference system (AC: 5)
  - [ ] Design conversation memory storage with structured topic tracking
  - [ ] Implement reference resolution for pronoun usage and topic continuation
  - [ ] Create ability to reference specific information mentioned earlier in call
  - [ ] Build conversation summary generation for handoff to staff or scheduling system
  - [ ] Implement conversation context enrichment with each exchange

- [ ] Test complex conversation scenarios (AC: 6)
  - [ ] Create test scenarios for topic switching (hours → insurance → location)
  - [ ] Test clarification request handling with elderly speech patterns
  - [ ] Validate conversation memory with references to earlier statements
  - [ ] Test interruption and correction scenarios during AI responses
  - [ ] Verify conversation timeout handling maintains professional experience

- [ ] Integrate with existing services
  - [ ] Connect conversation management with patient verification service (Story 2.1)
  - [ ] Integrate with practice information response system (Story 2.3)
  - [ ] Prepare handoff integration points for human escalation (Story 2.5)
  - [ ] Ensure compatibility with voice-to-text processing pipeline
  - [ ] Implement audit logging for multi-turn conversation compliance

- [ ] Implement unit and integration tests
  - [ ] Write unit tests for conversation state management with 85% coverage
  - [ ] Test conversation flow state transitions and memory persistence
  - [ ] Create integration tests for multi-service conversation scenarios
  - [ ] Test timeout handling and graceful degradation scenarios
  - [ ] Validate conversation memory accuracy and reference resolution

## Dev Notes

### Previous Story Dependencies
[Source: Epic 2 Story Sequence]
- **Story 2.1**: Patient verification service provides authenticated session context
- **Story 2.3**: Practice information responses are the primary content for multi-turn conversations
- Integration points established for seamless conversation flow across services

### Conversation Management Architecture
[Source: architecture/high-level-architecture.md]
- **Voice Processing Service** handles individual speech-to-text exchanges
- **Conversation state** stored in Redis for fast access and automatic expiration
- **Session management** coordinated across all microservices for unified patient experience
- **Natural language processing** using GPT-4 for context awareness and topic understanding

### Technical Implementation Strategy
[Source: architecture/tech-stack.md]
- **Redis 7.2**: Conversation state storage with TTL-based session management
- **GPT-4 API**: Context-aware conversation analysis and topic change detection
- **Node.js/TypeScript**: Conversation flow orchestration with Express.js endpoints
- **WebSocket consideration**: For real-time conversation state updates across services

### Conversation Flow Requirements
[Source: architecture/core-workflows.md]
- Natural conversation patterns appropriate for elderly demographic
- Clear verbal cues for topic transitions and conversation progression
- Polite timeout handling that doesn't feel abrupt or rude
- Professional conversation closing with helpful next steps

### HIPAA Compliance for Conversations
[Source: architecture/security.md]
- Conversation content must be encrypted in Redis storage
- Audit logs for multi-turn conversations required for compliance
- Session timeout enforced to limit PHI exposure duration
- Conversation memory purged completely after session expiration

### Performance Considerations
[Source: architecture/tech-stack.md]
- Redis session lookups must be <50ms to avoid conversation lag
- GPT-4 API calls optimized for conversation context without excessive token usage
- Conversation state kept minimal to reduce memory footprint
- Session cleanup processes to prevent Redis memory bloat

### Integration Points
[Source: architecture/components.md]
- **Patient Verification Service**: Provides authenticated patient context
- **Practice Information Service**: Supplies content for conversational responses
- **Voice Processing Service**: Handles speech-to-text and text-to-speech coordination
- **Audit Service**: Logs conversation patterns for HIPAA compliance and improvement analysis

### Testing Strategy for Conversations
[Source: architecture/test-strategy-and-standards.md]
- **Unit Tests**: Conversation state management, memory references, timeout handling
- **Integration Tests**: Multi-service conversation flows with realistic scenarios
- **End-to-End Tests**: Complete patient conversation journeys including escalation paths
- **Performance Tests**: Session storage performance under concurrent conversation load
- **User Acceptance Tests**: Elderly-friendly conversation flow validation

### Conversation Patterns for Elderly Patients
[Source: architecture/core-workflows.md]
- Slower speech recognition processing with longer pause tolerance
- Clear verbal confirmation of topic changes and conversation progression
- Frequent summary statements to ensure understanding and engagement
- Patient-friendly language avoiding medical jargon in multi-turn exchanges
- Graceful handling of repetitive questions or confusion

### File Structure
Based on monorepo structure from Story 1.1:
- `/packages/voice-ai-service/src/conversation/` - Main conversation management logic
- `/packages/voice-ai-service/src/conversation/session.ts` - Session state management
- `/packages/voice-ai-service/src/conversation/memory.ts` - Conversation memory and references
- `/packages/voice-ai-service/src/conversation/flow.ts` - Conversation flow state machine
- `/packages/shared-utils/src/redis/` - Redis conversation storage utilities

### Error Handling Scenarios
[Source: architecture/error-handling-strategy.md]
- **Redis Connection Failure**: Graceful degradation with in-memory session state
- **GPT-4 API Timeout**: Fallback to template-based responses with conversation continuation
- **Session Corruption**: Recovery with polite conversation restart request
- **Memory Reference Errors**: Fallback responses without breaking conversation flow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-14 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results