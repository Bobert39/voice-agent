# Story 3.2: New Appointment Booking

## Status
Todo

## Story
**As a** patient,  
**I want** to schedule a new appointment through voice conversation,  
**so that** I can secure my preferred time without waiting for business hours.

## Acceptance Criteria
1. Implement complete appointment booking workflow from availability check to OpenEMR confirmation
2. Create natural conversation flow that collects appointment type, preferred dates/times, and special requirements
3. Design confirmation protocol that repeats appointment details and requires explicit patient approval
4. Implement conflict detection and alternative suggestion when selected times become unavailable
5. Generate unique appointment confirmation numbers and provide multiple confirmation methods
6. Test booking workflow with various patient scenarios including first-time and returning patients

## Tasks / Subtasks
- [ ] Implement complete appointment booking workflow (AC: 1)
  - [ ] Create appointment booking state machine with clear conversation stages
  - [ ] Build integration with availability lookup system from Story 3.1
  - [ ] Implement OpenEMR Appointment resource creation via FHIR API
  - [ ] Design booking transaction rollback for failed confirmations
  - [ ] Create booking audit trail with complete transaction logging

- [ ] Build natural conversation collection flow (AC: 2)
  - [ ] Create appointment type collection with natural language understanding
  - [ ] Design preferred date/time gathering with flexible input formats
  - [ ] Implement special requirements collection (dilation needed, interpreter, accessibility)
  - [ ] Build conversation memory to track collected information across turns
  - [ ] Create clarification prompts for incomplete or ambiguous information

- [ ] Design comprehensive confirmation protocol (AC: 3)
  - [ ] Create appointment detail summary with clear date/time/location format
  - [ ] Implement explicit confirmation requirement with yes/no validation
  - [ ] Design confirmation readback that elderly patients can easily understand
  - [ ] Build confirmation retry logic for unclear or missed responses
  - [ ] Create booking finalization only after explicit patient approval

- [ ] Implement real-time conflict detection (AC: 4)
  - [ ] Create slot availability double-check immediately before booking
  - [ ] Design race condition handling for concurrent booking attempts
  - [ ] Implement alternative suggestion engine when conflicts detected
  - [ ] Build graceful conflict resolution with patient choice preservation
  - [ ] Create booking queue system for high-demand time slots

- [ ] Build confirmation number and delivery system (AC: 5)
  - [ ] Generate unique alphanumeric confirmation codes (8-character format)
  - [ ] Create voice confirmation delivery with slow, clear pronunciation
  - [ ] Implement text message confirmation option if phone number available
  - [ ] Design confirmation information storage for staff lookup capability
  - [ ] Build confirmation number validation for future appointment references

- [ ] Create comprehensive booking testing suite (AC: 6)
  - [ ] Build test scenarios for first-time patients (no OpenEMR record)
  - [ ] Create returning patient booking flows with history consideration
  - [ ] Design edge case testing (holidays, provider vacation, system maintenance)
  - [ ] Implement performance testing for booking under load
  - [ ] Create accessibility testing for various patient needs and limitations

- [ ] Implement booking conversation flow management
  - [ ] Design conversation state persistence across multiple interactions
  - [ ] Create booking session timeout handling with progress preservation
  - [ ] Build conversation repair for misunderstood or incorrect information
  - [ ] Implement booking abandonment detection with graceful recovery
  - [ ] Create handoff protocols for complex booking scenarios requiring human assistance

- [ ] Build appointment type-specific booking logic
  - [ ] Create routine exam booking flow (60-minute appointments)
  - [ ] Design follow-up appointment booking with reference to previous visits
  - [ ] Implement urgent appointment booking with priority handling
  - [ ] Build specialized appointment types (contact lens fitting, surgical consultation)
  - [ ] Create appointment duration calculation based on type and patient history

- [ ] Implement patient verification and data collection
  - [ ] Create patient identity verification using information from Story 2.1
  - [ ] Design new patient information collection flow
  - [ ] Build returning patient data validation and updates
  - [ ] Implement insurance information gathering for appointment preparation
  - [ ] Create emergency contact collection for new patients

- [ ] Design booking error handling and recovery
  - [ ] Create OpenEMR connection failure handling with graceful degradation
  - [ ] Implement booking timeout handling with automatic retry logic
  - [ ] Design invalid appointment type error recovery
  - [ ] Build patient information validation error handling
  - [ ] Create system maintenance mode with booking queue capability

- [ ] Build booking integration with practice workflow
  - [ ] Create staff notification system for new bookings
  - [ ] Implement booking preparation checklist generation based on appointment type
  - [ ] Design patient chart preparation triggers for new appointments
  - [ ] Build appointment confirmation delivery timing optimization
  - [ ] Create booking analytics tracking for practice management insights

- [ ] Implement booking performance optimization
  - [ ] Create booking response caching for common appointment types
  - [ ] Design database optimization for booking transaction performance
  - [ ] Implement connection pooling for high-volume booking periods
  - [ ] Build booking queue management for peak demand times
  - [ ] Create booking performance monitoring with real-time alerts

## Dev Notes

### Epic 3 Context
[Source: epic-3-appointment-scheduling-core.md]
- Core revenue-generating capability addressing $400-800 daily loss
- Complete appointment booking workflow with 24/7 availability
- Real-time OpenEMR integration critical for booking confirmation
- Natural voice conversation optimized for elderly patients

### OpenEMR Integration Requirements
[Source: architecture/integrations.md]
- **FHIR API**: Create Appointment resources with patient, practitioner, and slot references
- **Authentication**: OAuth2 with booking-level permissions
- **Transaction Safety**: Atomic booking operations with rollback capability
- **Conflict Prevention**: Real-time slot validation before booking confirmation
- **Audit Trail**: Complete booking transaction logging for compliance

### Conversation Flow Design
[Source: Story 2.4 Multi-turn conversation]
- State-based conversation management with booking context preservation
- Natural language collection of appointment preferences
- Clarification prompts for ambiguous or incomplete information
- Conversation repair mechanisms for misunderstood responses
- Timeout handling with booking progress preservation

### Patient Verification Integration
[Source: Story 2.1 Patient identity and verification]
- Integration with existing patient verification system
- New patient enrollment flow for first-time callers
- Returning patient data validation and updates
- Emergency contact and insurance information collection

### Business Rules Engine
[Source: architecture/business-logic.md]
- Appointment type duration mapping and scheduling constraints
- Provider availability and specialty matching
- Practice policy enforcement (advance booking limits, same-day restrictions)
- Special requirement handling (dilation, interpreter needs, accessibility)
- Holiday and closure calendar integration

### Elderly Patient Considerations
[Source: architecture/accessibility.md]
- Clear, step-by-step booking conversation flow
- Appointment detail confirmation with slow, clear readback
- Simple yes/no confirmation prompts
- Multiple confirmation delivery options (voice, text)
- Graceful handling of confusion or uncertainty

### HIPAA Compliance
[Source: architecture/security.md]
- Secure storage of booking conversation transcripts
- Patient data encryption during booking process
- Audit logging for all booking transactions
- Confirmation number generation without patient data exposure
- Secure integration with OpenEMR patient records

### Performance Requirements
[Source: architecture/performance-optimization.md]
- Booking completion time <60 seconds for standard appointments
- Conflict detection and resolution <5 seconds
- Support 20+ concurrent booking conversations
- Booking confirmation delivery <10 seconds
- OpenEMR booking confirmation <15 seconds

### Error Handling Strategy
[Source: architecture/error-handling-strategy.md]
- **OpenEMR Unavailable**: Queue booking with notification when system restored
- **Slot Conflict**: Immediate alternative suggestion with patient choice
- **Patient Verification Failure**: Graceful fallback to manual verification
- **Network Timeout**: Booking transaction preservation with retry logic
- **Invalid Information**: Clear correction prompts with examples

### Integration Points
[Source: architecture/components.md]
- **Availability Service**: Real-time slot checking from Story 3.1
- **Patient Service**: Identity verification and data management
- **OpenEMR Service**: Appointment creation and confirmation
- **Notification Service**: Confirmation delivery and staff alerts
- **Audit Service**: Booking transaction logging and compliance

### Testing Strategy
[Source: architecture/test-strategy-and-standards.md]
- **Unit Tests**: Booking logic, conflict detection, confirmation generation
- **Integration Tests**: OpenEMR booking creation, patient verification
- **Conversation Tests**: End-to-end booking conversation flows
- **Load Tests**: Concurrent booking handling, peak demand scenarios
- **Accessibility Tests**: Elderly patient booking experience validation

### File Structure
Following monorepo pattern from Story 1.1:
- `/packages/appointment-service/src/booking/` - Appointment booking logic
- `/packages/appointment-service/src/confirmation/` - Booking confirmation system
- `/packages/appointment-service/src/conversation/` - Booking conversation flows
- `/packages/appointment-service/src/validation/` - Patient and booking validation
- `/packages/appointment-service/src/notifications/` - Confirmation delivery system

### Booking State Management
[Source: architecture/state-management.md]
- **Conversation State**: Track booking progress across multiple turns
- **Booking Transaction**: Atomic operations with rollback capability
- **Patient Context**: Maintain patient information during booking process
- **Session Persistence**: Handle conversation timeouts and reconnections
- **Conflict Resolution**: Manage real-time booking conflicts gracefully

### Confirmation System Design
[Source: architecture/external-apis.md]
- **Voice Confirmation**: Clear pronunciation of confirmation details
- **Text Message**: SMS confirmation with appointment details
- **Confirmation Number**: 8-character alphanumeric code for reference
- **Staff Integration**: Confirmation lookup system for practice staff
- **Delivery Tracking**: Confirmation delivery status monitoring

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results