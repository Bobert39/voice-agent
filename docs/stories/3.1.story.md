# Story 3.1: Appointment Availability Lookup

## Status
Todo

## Story
**As a** patient,  
**I want** to know when appointments are available,  
**so that** I can choose a convenient time for my eye exam without multiple phone calls.

## Acceptance Criteria
1. Implement real-time calendar lookup in OpenEMR showing available appointment slots for next 60 days
2. Create intelligent slot filtering based on appointment type (routine exam, follow-up, urgent)
3. Design natural language responses for availability queries ("What times are available next week?")
4. Implement business rule filtering (no appointments during lunch, buffer time between patients)
5. Handle multiple appointment type scenarios with appropriate time slot allocations
6. Test availability lookup performance under concurrent patient request load

## Tasks / Subtasks
- [ ] Implement OpenEMR calendar integration API (AC: 1)
  - [ ] Create OpenEMR FHIR Appointment resource connector for calendar queries
  - [ ] Implement authentication and secure API connection to OpenEMR instance
  - [ ] Design calendar data retrieval for 60-day availability window
  - [ ] Create caching strategy for appointment slot data with 5-minute refresh
  - [ ] Handle OpenEMR API rate limiting and connection pooling

- [ ] Build appointment slot filtering system (AC: 2, 4, 5)
  - [ ] Create appointment type classification (routine: 60min, follow-up: 30min, urgent: 45min)
  - [ ] Implement business hours filtering (Mon-Fri 8am-5pm, lunch 12pm-1pm)
  - [ ] Design buffer time logic between appointments (10min standard, 15min for complex cases)
  - [ ] Create provider-specific availability rules and scheduling preferences
  - [ ] Implement holiday and practice closure calendar integration

- [ ] Design natural language availability response system (AC: 3)
  - [ ] Create GPT-4 prompt templates for availability query understanding
  - [ ] Build time reference parser ("next week", "tomorrow", "Monday morning")
  - [ ] Design conversational availability responses for elderly patients
  - [ ] Implement multiple time slot presentation (max 3 options per response)
  - [ ] Create fallback responses for no availability scenarios

- [ ] Implement availability query processing pipeline (AC: 3)
  - [ ] Build NLU intent detection for appointment availability requests
  - [ ] Create date/time entity extraction from patient utterances
  - [ ] Design query normalization for varied patient phrasings
  - [ ] Implement contextual query refinement ("Do you have anything earlier?")
  - [ ] Handle ambiguous time references with clarification prompts

- [ ] Build appointment type determination logic (AC: 2, 5)
  - [ ] Create conversation flow to determine appointment type if not specified
  - [ ] Implement appointment duration mapping based on type and patient history
  - [ ] Design special requirement detection (dilation needed, translator required)
  - [ ] Build appointment type validation against provider capabilities
  - [ ] Create appointment type suggestion based on patient history

- [ ] Implement performance optimization and caching (AC: 6)
  - [ ] Design Redis-based availability cache with intelligent invalidation
  - [ ] Create database query optimization for calendar lookups
  - [ ] Implement connection pooling for OpenEMR API calls
  - [ ] Build load balancing for concurrent availability requests
  - [ ] Design graceful degradation for high-load scenarios

- [ ] Create comprehensive testing suite (AC: 6)
  - [ ] Build unit tests for availability filtering logic (90% coverage)
  - [ ] Create integration tests for OpenEMR calendar API interaction
  - [ ] Design load tests simulating 50+ concurrent availability queries
  - [ ] Implement end-to-end tests for complete availability lookup flows
  - [ ] Create performance benchmarks for sub-2-second response times

- [ ] Integrate with existing conversation system
  - [ ] Connect with multi-turn conversation management (Story 2.4)
  - [ ] Integrate with patient verification for personalized availability
  - [ ] Build handoff to appointment booking flow (Story 3.2)
  - [ ] Implement audit logging for availability queries
  - [ ] Create fallback to human staff for complex scheduling needs

## Dev Notes

### Epic 3 Context
[Source: epic-3-appointment-scheduling-core.md]
- Core revenue-generating capability addressing $400-800 daily loss
- 24/7 appointment scheduling through natural voice interactions
- Real-time OpenEMR integration critical for accurate availability
- Focus on elderly patient-friendly conversation patterns

### OpenEMR Integration Requirements
[Source: architecture/integrations.md]
- **FHIR API**: Use Appointment and Slot resources for availability
- **Authentication**: OAuth2 with practice-specific credentials
- **Data Sync**: 5-minute cache refresh for availability changes
- **Rate Limiting**: Max 100 requests/minute to OpenEMR API
- **Error Handling**: Graceful fallback for API unavailability

### Natural Language Processing
[Source: Story 2.2 NLU integration]
- Intent detection for appointment-related queries
- Entity extraction for dates, times, and appointment types
- Context awareness for relative time references
- Clarification prompts for ambiguous requests

### Performance Requirements
[Source: architecture/performance-optimization.md]
- Availability query response time <2 seconds
- Support 50+ concurrent availability lookups
- Redis cache hit ratio >90% for common queries
- OpenEMR API response caching for 5 minutes
- Graceful degradation under load

### Business Rules Engine
[Source: architecture/business-logic.md]
- Appointment types: Routine (60min), Follow-up (30min), Urgent (45min)
- Buffer times: 10min standard, 15min for dilated exams
- Lunch blocks: 12pm-1pm daily (configurable)
- Provider-specific scheduling preferences
- Holiday and special closure handling

### Elderly Patient Considerations
[Source: architecture/accessibility.md]
- Present maximum 3 time options to avoid confusion
- Use clear day/time descriptions ("Tuesday morning at 10")
- Avoid military time in responses
- Repeat availability clearly with confirmation prompts
- Offer to repeat or clarify information

### HIPAA Compliance
[Source: architecture/security.md]
- Availability queries logged without patient PHI
- Appointment type preferences stored securely
- Cache invalidation on patient request changes
- Audit trail for all availability lookups
- No patient data in availability cache keys

### Integration Points
[Source: architecture/components.md]
- **OpenEMR Service**: Calendar and appointment slot queries
- **NLU Service**: Intent and entity extraction for queries
- **Conversation Service**: Multi-turn availability refinement
- **Cache Service**: Redis-based availability caching
- **Audit Service**: Compliance logging for queries

### Testing Strategy
[Source: architecture/test-strategy-and-standards.md]
- **Unit Tests**: Business rule filtering, time slot calculations
- **Integration Tests**: OpenEMR API interaction, cache behavior
- **Load Tests**: Concurrent query handling, cache performance
- **E2E Tests**: Complete availability conversation flows
- **Accessibility Tests**: Elderly-friendly response validation

### File Structure
Following monorepo pattern from Story 1.1:
- `/packages/appointment-service/` - New service for appointment management
- `/packages/appointment-service/src/availability/` - Availability lookup logic
- `/packages/appointment-service/src/openemr/` - OpenEMR integration layer
- `/packages/appointment-service/src/rules/` - Business rule engine
- `/packages/appointment-service/src/cache/` - Availability caching logic

### Error Scenarios
[Source: architecture/error-handling-strategy.md]
- **OpenEMR Unavailable**: Use last known availability with warning
- **Cache Miss**: Direct OpenEMR query with increased timeout
- **Invalid Date Request**: Polite clarification and examples
- **No Availability**: Suggest alternative dates or callback list
- **API Rate Limit**: Queue request with polite delay message

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results